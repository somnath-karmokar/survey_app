{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">{{ survey.name }}</h2>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <table class="table">
                            <tbody>
                                {% for field in form.visible_fields %}
                                    <tr>
                                        <th>
                                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {% if field.help_text %}
                                                <small class="form-text text-muted d-block">{{ field.help_text }}</small>
                                            {% endif %}
                                        </th>
                                        <td>
                                            {% with question_type=field.field.widget.attrs.data_question_type %}
                                                {% if question_type == 'text' %}
                                                    <textarea 
                                                        name="{{ field.name }}" 
                                                        id="{{ field.id_for_label }}"
                                                        class="form-control {% if field.errors %}is-invalid{% endif %}"
                                                        rows="3"
                                                        {% if field.field.required %}required{% endif %}
                                                    >{% if field.value %}{{ field.value }}{% endif %}</textarea>
                                                {% elif question_type == 'single_choice' %}
                                                    <div class="form-group">
                                                        {% for choice in field.field.choices %}
                                                            <div class="form-check">
                                                                <input 
                                                                    type="radio" 
                                                                    name="{{ field.name }}" 
                                                                    value="{{ choice.0 }}"
                                                                    id="id_{{ field.name }}_{{ forloop.counter0 }}"
                                                                    class="form-check-input {% if field.errors %}is-invalid{% endif %}"
                                                                    {% if field.value == choice.0|stringformat:"s" %}checked{% endif %}
                                                                    {% if field.field.required %}required{% endif %}
                                                                >
                                                                <label class="form-check-label" for="id_{{ field.name }}_{{ forloop.counter0 }}">
                                                                    {{ choice.1 }}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% elif question_type == 'multiple_choice' %}
                                                    <div class="form-group">
                                                        {% for choice in field.field.choices %}
                                                            <div class="form-check">
                                                                <input 
                                                                    type="checkbox" 
                                                                    name="{{ field.name }}" 
                                                                    value="{{ choice.0 }}"
                                                                    id="id_{{ field.name }}_{{ forloop.counter0 }}"
                                                                    class="form-check-input {% if field.errors %}is-invalid{% endif %}"
                                                                    {% if choice.0|stringformat:"s" in field.value %}checked{% endif %}
                                                                    {% if field.field.required %}required{% endif %}
                                                                >
                                                                <label class="form-check-label" for="id_{{ field.name }}_{{ forloop.counter0 }}">
                                                                    {{ choice.1 }}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% elif question_type == 'rating' %}
                                                    <div class="form-group">
                                                        <input 
                                                            type="range" 
                                                            name="{{ field.name }}"
                                                            id="{{ field.id_for_label }}"
                                                            class="form-range"
                                                            min="1" 
                                                            max="5" 
                                                            value="{{ field.value|default:'3' }}"
                                                            oninput="document.getElementById('rating-value-{{ field.id_for_label }}').textContent = this.value"
                                                        >
                                                        <div class="d-flex justify-content-between">
                                                            <small>1 (Poor)</small>
                                                            <small>5 (Excellent)</small>
                                                        </div>
                                                        <div class="text-center">
                                                            <span id="rating-value-{{ field.id_for_label }}" class="badge bg-primary">
                                                                {{ field.value|default:'3' }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                            
                                            {% if field.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ field.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-center mt-4">
                            <!-- <a href="{% url 'surveys:category_detail' category_slug=survey.category.slug %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-arrow-left me-2"></i>Back to Survey
                            </a> -->
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Start Survey
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-check {
        padding-left: 0;
    }
    .form-check-input {
        margin-right: 0.5rem;
    }
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
</style>

<script>
    // Client-side form validation
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}